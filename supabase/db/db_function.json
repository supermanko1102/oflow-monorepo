[
  {
    "schema": "public",
    "function_name": "accept_team_invite",
    "definition": "CREATE OR REPLACE FUNCTION public.accept_team_invite(p_invite_code text, p_user_id uuid)\n RETURNS uuid\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  v_team_id UUID;\n  v_role TEXT;\n  v_invite_id UUID;\nBEGIN\n  -- 查找有效的邀請碼\n  SELECT id, team_id, role INTO v_invite_id, v_team_id, v_role\n  FROM team_invites\n  WHERE invite_code = p_invite_code\n    AND is_active = true\n    AND (expires_at IS NULL OR expires_at > NOW())\n    AND (max_uses IS NULL OR uses_count < max_uses);\n\n  IF v_team_id IS NULL THEN\n    RAISE EXCEPTION 'Invalid or expired invite code';\n  END IF;\n\n  -- 檢查用戶是否已加入\n  IF EXISTS (\n    SELECT 1 FROM team_members\n    WHERE team_id = v_team_id AND user_id = p_user_id\n  ) THEN\n    RAISE EXCEPTION 'User already a member of this team';\n  END IF;\n\n  -- 加入團隊\n  INSERT INTO team_members (team_id, user_id, role)\n  VALUES (v_team_id, p_user_id, v_role);\n\n  -- 更新邀請碼使用次數\n  UPDATE team_invites\n  SET uses_count = uses_count + 1\n  WHERE id = v_invite_id;\n\n  -- 更新團隊成員數\n  UPDATE teams\n  SET member_count = member_count + 1\n  WHERE id = v_team_id;\n\n  RETURN v_team_id;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "check_subscription_valid",
    "definition": "CREATE OR REPLACE FUNCTION public.check_subscription_valid(p_team_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  team_record RECORD;\nBEGIN\n  SELECT * INTO team_record FROM teams WHERE id = p_team_id;\n\n  IF team_record IS NULL THEN\n    RETURN false;\n  END IF;\n\n  -- 試用期內\n  IF team_record.subscription_status = 'trial'\n     AND team_record.trial_ends_at > NOW() THEN\n    RETURN true;\n  END IF;\n\n  -- 付費中\n  IF team_record.subscription_status = 'active'\n     AND team_record.subscription_current_period_end > NOW() THEN\n    RETURN true;\n  END IF;\n\n  -- 其他情況：過期\n  RETURN false;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "check_team_line_configured",
    "definition": "CREATE OR REPLACE FUNCTION public.check_team_line_configured(p_team_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  team_record RECORD;\nBEGIN\n  SELECT \n    line_channel_id, \n    line_channel_secret, \n    line_channel_access_token \n  INTO team_record \n  FROM teams \n  WHERE id = p_team_id;\n\n  IF team_record IS NULL THEN\n    RETURN false;\n  END IF;\n\n  -- 檢查必要的 LINE 設定是否都已填寫\n  IF team_record.line_channel_id IS NOT NULL \n     AND team_record.line_channel_secret IS NOT NULL \n     AND team_record.line_channel_access_token IS NOT NULL THEN\n    RETURN true;\n  END IF;\n\n  RETURN false;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "cleanup_abandoned_conversations",
    "definition": "CREATE OR REPLACE FUNCTION public.cleanup_abandoned_conversations()\n RETURNS integer\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  v_count INTEGER;\nBEGIN\n  -- 更新超過 24 小時無回應的對話狀態\n  UPDATE conversations\n  SET \n    status = 'abandoned',\n    updated_at = NOW()\n  WHERE status = 'collecting_info'\n    AND last_message_at < NOW() - INTERVAL '24 hours';\n\n  GET DIAGNOSTICS v_count = ROW_COUNT;\n  \n  RETURN v_count;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "complete_conversation",
    "definition": "CREATE OR REPLACE FUNCTION public.complete_conversation(p_conversation_id uuid, p_order_id uuid)\n RETURNS void\n LANGUAGE plpgsql\nAS $function$\nBEGIN\n  -- 更新對話狀態\n  UPDATE conversations\n  SET \n    status = 'completed',\n    order_id = p_order_id,\n    updated_at = NOW()\n  WHERE id = p_conversation_id;\n\n  -- 更新訂單的 conversation_id\n  UPDATE orders\n  SET conversation_id = p_conversation_id\n  WHERE id = p_order_id;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "create_default_team_settings",
    "definition": "CREATE OR REPLACE FUNCTION public.create_default_team_settings()\n RETURNS trigger\n LANGUAGE plpgsql\nAS $function$\nBEGIN\n  -- 建立預設團隊設定\n  INSERT INTO team_settings (\n    team_id,\n    business_hours,\n    holidays,\n    order_lead_time_days,\n    max_daily_orders,\n    reminder_days,\n    notification_time,\n    ai_auto_confirm,\n    ai_confidence_threshold\n  )\n  VALUES (\n    NEW.id,\n    jsonb_build_object(\n      'monday', jsonb_build_object('open', '09:00', 'close', '18:00', 'closed', false),\n      'tuesday', jsonb_build_object('open', '09:00', 'close', '18:00', 'closed', false),\n      'wednesday', jsonb_build_object('open', '09:00', 'close', '18:00', 'closed', false),\n      'thursday', jsonb_build_object('open', '09:00', 'close', '18:00', 'closed', false),\n      'friday', jsonb_build_object('open', '09:00', 'close', '18:00', 'closed', false),\n      'saturday', jsonb_build_object('open', '09:00', 'close', '18:00', 'closed', false),\n      'sunday', jsonb_build_object('open', '09:00', 'close', '18:00', 'closed', true)\n    ),\n    ARRAY[]::DATE[], -- 沒有預設公休日\n    3,               -- 預設提前 3 天\n    20,              -- 預設每日最多 20 單\n    ARRAY[7, 3, 1],  -- 7天前、3天前、1天前提醒\n    '09:00',         -- 早上 9 點提醒\n    false,           -- 預設不自動確認\n    0.8              -- AI 信心度門檻 80%\n  );\n\n  RETURN NEW;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "create_order",
    "definition": "CREATE OR REPLACE FUNCTION public.create_order(p_team_id uuid, p_created_by uuid, p_customer_name text, p_customer_phone text, p_items jsonb, p_total_amount numeric, p_pickup_date date, p_pickup_time time without time zone, p_source text DEFAULT 'auto'::text, p_notes text DEFAULT NULL::text)\n RETURNS uuid\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  v_order_id UUID;\n  v_customer_id UUID;\n  v_order_number TEXT;\nBEGIN\n  -- 生成訂單編號（團隊層級）\n  v_order_number := generate_order_number(p_team_id);\n\n  -- 查找或建立顧客（在團隊內）\n  SELECT id INTO v_customer_id\n  FROM customers\n  WHERE team_id = p_team_id AND phone = p_customer_phone;\n\n  IF v_customer_id IS NULL THEN\n    INSERT INTO customers (team_id, name, phone)\n    VALUES (p_team_id, p_customer_name, p_customer_phone)\n    RETURNING id INTO v_customer_id;\n  END IF;\n\n  -- 建立訂單\n  INSERT INTO orders (\n    team_id, customer_id, order_number, customer_name, customer_phone,\n    items, total_amount, pickup_date, pickup_time, source, notes,\n    created_by, updated_by\n  )\n  VALUES (\n    p_team_id, v_customer_id, v_order_number, p_customer_name, p_customer_phone,\n    p_items, p_total_amount, p_pickup_date, p_pickup_time, p_source, p_notes,\n    p_created_by, p_created_by\n  )\n  RETURNING id INTO v_order_id;\n\n  -- 更新顧客統計\n  UPDATE customers\n  SET\n    total_orders = total_orders + 1,\n    total_spent = total_spent + p_total_amount,\n    last_order_at = NOW()\n  WHERE id = v_customer_id;\n\n  -- 更新團隊統計\n  UPDATE teams\n  SET\n    total_orders = total_orders + 1,\n    total_revenue = total_revenue + p_total_amount\n  WHERE id = p_team_id;\n\n  RETURN v_order_id;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "create_order_from_ai",
    "definition": "CREATE OR REPLACE FUNCTION public.create_order_from_ai(p_team_id uuid, p_customer_name text, p_customer_phone text, p_items jsonb, p_total_amount numeric, p_line_message_id uuid, p_original_message text, p_appointment_date date, p_appointment_time time without time zone DEFAULT NULL::time without time zone, p_status text DEFAULT 'draft'::text, p_delivery_method text DEFAULT 'pickup'::text, p_pickup_type text DEFAULT NULL::text, p_pickup_location text DEFAULT NULL::text, p_requires_frozen boolean DEFAULT false, p_store_info text DEFAULT NULL::text, p_shipping_address text DEFAULT NULL::text, p_service_duration integer DEFAULT NULL::integer, p_service_notes text DEFAULT NULL::text, p_customer_notes text DEFAULT NULL::text, p_conversation_id uuid DEFAULT NULL::uuid)\n RETURNS uuid\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  v_order_id UUID;\n  v_customer_id UUID;\n  v_order_number TEXT;\n  v_line_user_id TEXT;\n  v_time time := COALESCE(p_appointment_time, TIME '00:00:00');\n  v_status text := COALESCE(NULLIF(p_status, ''), 'draft');\nBEGIN\n  -- 生成訂單編號（團隊層級）\n  v_order_number := generate_order_number(p_team_id);\n\n  -- 從 LINE 訊息取得顧客的 LINE ID\n  SELECT line_user_id INTO v_line_user_id\n  FROM line_messages\n  WHERE id = p_line_message_id;\n\n  -- 查找或建立顧客（在團隊內）\n  -- 先用電話查找\n  IF p_customer_phone IS NOT NULL AND p_customer_phone != '' THEN\n    SELECT id INTO v_customer_id\n    FROM customers\n    WHERE team_id = p_team_id AND phone = p_customer_phone;\n  END IF;\n\n  -- 如果電話找不到，用 LINE ID 查找\n  IF v_customer_id IS NULL AND v_line_user_id IS NOT NULL THEN\n    SELECT id INTO v_customer_id\n    FROM customers\n    WHERE team_id = p_team_id AND line_user_id = v_line_user_id;\n  END IF;\n\n  -- 如果都找不到，建立新顧客\n  IF v_customer_id IS NULL THEN\n    INSERT INTO customers (team_id, name, phone, line_user_id)\n    VALUES (p_team_id, p_customer_name, p_customer_phone, v_line_user_id)\n    RETURNING id INTO v_customer_id;\n  ELSE\n    -- 更新現有顧客的資訊（如果有新資訊）\n    UPDATE customers\n    SET\n      name = COALESCE(p_customer_name, name),\n      phone = COALESCE(NULLIF(p_customer_phone, ''), phone),\n      line_user_id = COALESCE(v_line_user_id, line_user_id),\n      updated_at = NOW()\n    WHERE id = v_customer_id;\n  END IF;\n\n  -- 建立訂單（加入 pickup_type 和 pickup_location）\n  INSERT INTO orders (\n    team_id, customer_id, order_number, customer_name, customer_phone,\n    items, total_amount, \n    pickup_date, pickup_time,\n    delivery_method,\n    pickup_type, pickup_location,            -- 新增欄位\n    requires_frozen, store_info, shipping_address,\n    service_duration, service_notes,\n    source, status, notes, customer_notes,\n    original_message, line_conversation_id, conversation_id,\n    created_at\n  )\n  VALUES (\n    p_team_id, v_customer_id, v_order_number, p_customer_name, p_customer_phone,\n    p_items, p_total_amount,\n    p_appointment_date, v_time,\n    p_delivery_method,\n    p_pickup_type, p_pickup_location,        -- 新增值\n    p_requires_frozen, p_store_info, p_shipping_address,\n    p_service_duration, p_service_notes,\n    'auto', v_status, NULL, p_customer_notes,\n    p_original_message, v_line_user_id, p_conversation_id,\n    NOW()\n  )\n  RETURNING id INTO v_order_id;\n\n  -- 關聯 LINE 訊息與訂單\n  UPDATE line_messages\n  SET order_id = v_order_id\n  WHERE id = p_line_message_id;\n\n  -- 更新顧客統計\n  UPDATE customers\n  SET\n    total_orders = total_orders + 1,\n    total_spent = total_spent + p_total_amount,\n    last_order_at = NOW()\n  WHERE id = v_customer_id;\n\n  -- 更新團隊統計\n  UPDATE teams\n  SET\n    total_orders = total_orders + 1,\n    total_revenue = total_revenue + p_total_amount\n  WHERE id = p_team_id;\n\n  -- 建立提醒（僅正式訂單，不包含 draft）\n  IF v_status <> 'draft' AND p_appointment_date > CURRENT_DATE THEN\n    -- 7天前提醒\n    IF p_appointment_date - INTERVAL '7 days' > NOW() THEN\n      INSERT INTO reminders (team_id, order_id, remind_type, remind_time, title, message)\n      VALUES (\n        p_team_id, v_order_id, '7day',\n        (p_appointment_date - INTERVAL '7 days')::DATE + TIME '09:00:00',\n        '7天後訂單提醒',\n        '訂單 ' || v_order_number || ' 將於 7 天後處理'\n      );\n    END IF;\n\n    -- 3天前提醒\n    IF p_appointment_date - INTERVAL '3 days' > NOW() THEN\n      INSERT INTO reminders (team_id, order_id, remind_type, remind_time, title, message)\n      VALUES (\n        p_team_id, v_order_id, '3day',\n        (p_appointment_date - INTERVAL '3 days')::DATE + TIME '09:00:00',\n        '3天後訂單提醒',\n        '訂單 ' || v_order_number || ' 將於 3 天後處理'\n      );\n    END IF;\n\n    -- 1天前提醒\n    IF p_appointment_date - INTERVAL '1 day' > NOW() THEN\n      INSERT INTO reminders (team_id, order_id, remind_type, remind_time, title, message)\n      VALUES (\n        p_team_id, v_order_id, '1day',\n        (p_appointment_date - INTERVAL '1 day')::DATE + TIME '09:00:00',\n        '明天訂單提醒',\n        '訂單 ' || v_order_number || ' 將於明天處理'\n      );\n    END IF;\n\n    -- 當天提醒\n    INSERT INTO reminders (team_id, order_id, remind_type, remind_time, title, message)\n    VALUES (\n      p_team_id, v_order_id, 'today',\n      p_appointment_date + TIME '08:00:00',\n      '今日訂單提醒',\n      '訂單 ' || v_order_number || ' 今天要處理'\n    );\n  END IF;\n\n  RETURN v_order_id;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "create_reminders_on_order_confirm",
    "definition": "CREATE OR REPLACE FUNCTION public.create_reminders_on_order_confirm()\n RETURNS trigger\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  reminder_days INT[];\n  day INT;\n  notification_time TIME;\nBEGIN\n  -- 只在訂單狀態變更為 confirmed 時執行\n  IF NEW.status = 'confirmed' AND (OLD.status IS NULL OR OLD.status != 'confirmed') THEN\n    \n    -- 取得團隊提醒設定\n    SELECT ts.reminder_days, ts.notification_time \n    INTO reminder_days, notification_time\n    FROM team_settings ts\n    WHERE ts.team_id = NEW.team_id;\n\n    -- 如果沒有設定，使用預設值\n    IF reminder_days IS NULL THEN\n      reminder_days := ARRAY[7, 3, 1];\n    END IF;\n    \n    IF notification_time IS NULL THEN\n      notification_time := '09:00';\n    END IF;\n\n    -- 為每個提醒天數建立提醒\n    FOREACH day IN ARRAY reminder_days\n    LOOP\n      -- 只在提醒時間還沒過的情況下建立\n      IF (NEW.pickup_date - day) >= CURRENT_DATE THEN\n        INSERT INTO reminders (team_id, order_id, remind_type, remind_time, title, message)\n        VALUES (\n          NEW.team_id,\n          NEW.id,\n          day || 'day',\n          (NEW.pickup_date - day * INTERVAL '1 day') + notification_time,\n          '訂單提醒',\n          format('%s 天後有訂單取件：%s', day, NEW.customer_name)\n        );\n      END IF;\n    END LOOP;\n\n    -- 特別處理當天提醒\n    IF NEW.pickup_date = CURRENT_DATE THEN\n      INSERT INTO reminders (team_id, order_id, remind_type, remind_time, title, message)\n      VALUES (\n        NEW.team_id,\n        NEW.id,\n        'today',\n        NOW() + INTERVAL '5 minutes', -- 5 分鐘後提醒\n        '今日訂單提醒',\n        format('今天有訂單取件：%s（%s %s）', NEW.customer_name, NEW.pickup_date, NEW.pickup_time)\n      );\n    END IF;\n\n  END IF;\n\n  RETURN NEW;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "create_team_with_owner",
    "definition": "CREATE OR REPLACE FUNCTION public.create_team_with_owner(p_user_id uuid, p_team_name text, p_line_channel_id text DEFAULT NULL::text, p_business_type text DEFAULT 'bakery'::text)\n RETURNS TABLE(team_id uuid, team_name text, team_slug text, invite_code text)\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  v_team_id UUID;\n  v_slug TEXT;\n  v_invite_code TEXT;\nBEGIN\n  -- 生成 slug（簡化版，將空格轉為短橫線，轉小寫）\n  v_slug := LOWER(REGEXP_REPLACE(p_team_name, '\\s+', '-', 'g'));\n  \n  -- 確保 slug 唯一（如果重複，加上隨機後綴）\n  WHILE EXISTS (SELECT 1 FROM teams WHERE slug = v_slug) LOOP\n    v_slug := v_slug || '-' || SUBSTRING(MD5(RANDOM()::TEXT) FROM 1 FOR 4);\n  END LOOP;\n\n  -- 建立團隊\n  INSERT INTO teams (\n    name, \n    slug, \n    line_channel_id, \n    business_type,\n    subscription_status,\n    trial_started_at,\n    trial_ends_at\n  )\n  VALUES (\n    p_team_name,\n    v_slug,\n    p_line_channel_id,\n    p_business_type,\n    'trial',\n    NOW(),\n    NOW() + INTERVAL '3 days'\n  )\n  RETURNING id INTO v_team_id;\n\n  -- 將建立者加入為 owner\n  INSERT INTO team_members (\n    team_id,\n    user_id,\n    role,\n    can_manage_orders,\n    can_manage_customers,\n    can_manage_settings,\n    can_view_analytics,\n    can_invite_members\n  )\n  VALUES (\n    v_team_id,\n    p_user_id,\n    'owner',\n    true,\n    true,\n    true,\n    true,\n    true\n  );\n\n  -- 生成邀請碼\n  v_invite_code := generate_invite_code(v_slug);\n  \n  -- 建立預設邀請碼\n  INSERT INTO team_invites (\n    team_id,\n    invite_code,\n    invited_by,\n    role,\n    is_active\n  )\n  VALUES (\n    v_team_id,\n    v_invite_code,\n    p_user_id,\n    'member',\n    true\n  );\n\n  -- 回傳團隊資訊\n  RETURN QUERY\n  SELECT \n    v_team_id,\n    p_team_name,\n    v_slug,\n    v_invite_code;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "delete_team",
    "definition": "CREATE OR REPLACE FUNCTION public.delete_team(p_team_id uuid, p_user_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  v_member_role TEXT;\n  v_team_name TEXT;\n  v_member_count INT;\nBEGIN\n  -- 檢查權限（只有 owner 可以刪除）\n  SELECT role INTO v_member_role\n  FROM team_members\n  WHERE team_id = p_team_id AND user_id = p_user_id;\n\n  IF v_member_role IS NULL THEN\n    RAISE EXCEPTION 'User is not a member of this team';\n  END IF;\n\n  IF v_member_role != 'owner' THEN\n    RAISE EXCEPTION 'Only team owner can delete the team';\n  END IF;\n\n  -- 取得團隊資訊（用於日誌）\n  SELECT name, member_count INTO v_team_name, v_member_count\n  FROM teams\n  WHERE id = p_team_id;\n\n  IF v_team_name IS NULL THEN\n    RAISE EXCEPTION 'Team not found';\n  END IF;\n\n  -- 永久刪除團隊（CASCADE 會自動刪除相關資料）\n  DELETE FROM teams\n  WHERE id = p_team_id;\n\n  RAISE NOTICE '團隊 \"%\" (成員數: %) 已永久刪除', v_team_name, v_member_count;\n\n  RETURN true;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "delete_user_account",
    "definition": "CREATE OR REPLACE FUNCTION public.delete_user_account(p_user_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\n SECURITY DEFINER\nAS $function$\nDECLARE\n  v_team_record RECORD;\n  v_team_member_count INT;\nBEGIN\n  RAISE NOTICE '開始刪除用戶帳號: %', p_user_id;\n\n  -- 1. 處理用戶所屬的所有團隊\n  FOR v_team_record IN \n    SELECT tm.team_id, tm.role, t.name as team_name\n    FROM team_members tm\n    JOIN teams t ON t.id = tm.team_id\n    WHERE tm.user_id = p_user_id\n  LOOP\n    RAISE NOTICE '處理團隊: % (角色: %)', v_team_record.team_name, v_team_record.role;\n\n    -- 如果是 owner，檢查是否為唯一 owner\n    IF v_team_record.role = 'owner' THEN\n      -- 計算該團隊的成員數\n      SELECT COUNT(*) INTO v_team_member_count\n      FROM team_members\n      WHERE team_id = v_team_record.team_id;\n\n      RAISE NOTICE '團隊 % 成員數: %', v_team_record.team_name, v_team_member_count;\n\n      -- 如果是唯一成員（唯一 owner），刪除整個團隊\n      IF v_team_member_count = 1 THEN\n        RAISE NOTICE '用戶是團隊 % 的唯一成員，刪除整個團隊', v_team_record.team_name;\n        DELETE FROM teams WHERE id = v_team_record.team_id;\n      ELSE\n        -- 如果團隊有其他成員，嘗試將 owner 轉移給第一個 admin\n        DECLARE\n          v_new_owner_id UUID;\n        BEGIN\n          SELECT user_id INTO v_new_owner_id\n          FROM team_members\n          WHERE team_id = v_team_record.team_id \n            AND user_id != p_user_id\n            AND role = 'admin'\n          LIMIT 1;\n\n          IF v_new_owner_id IS NOT NULL THEN\n            -- 轉移 owner 給 admin\n            RAISE NOTICE '將團隊 % 的 owner 轉移給 admin: %', v_team_record.team_name, v_new_owner_id;\n            UPDATE team_members\n            SET role = 'owner'\n            WHERE team_id = v_team_record.team_id AND user_id = v_new_owner_id;\n            \n            -- 刪除該用戶的成員記錄\n            DELETE FROM team_members\n            WHERE team_id = v_team_record.team_id AND user_id = p_user_id;\n          ELSE\n            -- 沒有 admin 可以接手，將 owner 轉移給第一個 member\n            SELECT user_id INTO v_new_owner_id\n            FROM team_members\n            WHERE team_id = v_team_record.team_id \n              AND user_id != p_user_id\n            LIMIT 1;\n\n            IF v_new_owner_id IS NOT NULL THEN\n              RAISE NOTICE '將團隊 % 的 owner 轉移給 member: %', v_team_record.team_name, v_new_owner_id;\n              UPDATE team_members\n              SET role = 'owner'\n              WHERE team_id = v_team_record.team_id AND user_id = v_new_owner_id;\n              \n              -- 刪除該用戶的成員記錄\n              DELETE FROM team_members\n              WHERE team_id = v_team_record.team_id AND user_id = p_user_id;\n            ELSE\n              -- 理論上不應該到這裡\n              RAISE NOTICE '無法找到接手者，刪除整個團隊';\n              DELETE FROM teams WHERE id = v_team_record.team_id;\n            END IF;\n          END IF;\n        END;\n      END IF;\n    ELSE\n      -- 如果不是 owner，直接移除成員記錄\n      RAISE NOTICE '從團隊 % 移除成員', v_team_record.team_name;\n      DELETE FROM team_members\n      WHERE team_id = v_team_record.team_id AND user_id = p_user_id;\n    END IF;\n  END LOOP;\n\n  -- 2. 刪除 public.users 記錄\n  RAISE NOTICE '刪除 public.users 記錄';\n  DELETE FROM users WHERE id = p_user_id;\n\n  -- 3. 刪除 auth.users 記錄\n  -- 注意：這需要從 auth.users 表刪除，需要 service_role 權限\n  -- 在 Edge Function 中處理\n  \n  RAISE NOTICE '用戶帳號刪除完成: %', p_user_id;\n  \n  RETURN true;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "generate_invite_code",
    "definition": "CREATE OR REPLACE FUNCTION public.generate_invite_code(p_team_slug text)\n RETURNS text\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  random_part TEXT;\nBEGIN\n  random_part := UPPER(SUBSTRING(MD5(RANDOM()::TEXT) FROM 1 FOR 6));\n  RETURN UPPER(p_team_slug) || '-' || random_part;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "generate_order_number",
    "definition": "CREATE OR REPLACE FUNCTION public.generate_order_number(p_team_id uuid)\n RETURNS text\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  today_date TEXT;\n  order_count INT;\n  order_num TEXT;\nBEGIN\n  today_date := TO_CHAR(NOW(), 'YYYYMMDD');\n\n  -- 計算該團隊今天的訂單數\n  SELECT COUNT(*) INTO order_count\n  FROM orders\n  WHERE team_id = p_team_id\n    AND order_number LIKE 'ORD-' || today_date || '-%';\n\n  order_num := 'ORD-' || today_date || '-' || LPAD((order_count + 1)::TEXT, 3, '0');\n\n  RETURN order_num;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "get_conversation_history",
    "definition": "CREATE OR REPLACE FUNCTION public.get_conversation_history(p_conversation_id uuid, p_limit integer DEFAULT 5)\n RETURNS TABLE(role text, message text, created_at timestamp with time zone)\n LANGUAGE plpgsql\nAS $function$\nBEGIN\n  RETURN QUERY\n  SELECT \n    lm.role,\n    lm.message_text AS message,\n    lm.created_at\n  FROM line_messages lm\n  WHERE lm.conversation_id = p_conversation_id\n  ORDER BY lm.created_at DESC\n  LIMIT p_limit;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "get_daily_summary",
    "definition": "CREATE OR REPLACE FUNCTION public.get_daily_summary(p_team_id uuid, p_date date)\n RETURNS jsonb\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  result JSONB;\nBEGIN\n  SELECT jsonb_build_object(\n    'total_orders', COUNT(*),\n    'total_amount', COALESCE(SUM(total_amount), 0),\n    'pending_orders', COUNT(*) FILTER (WHERE status = 'pending'),\n    'confirmed_orders', COUNT(*) FILTER (WHERE status = 'confirmed'),\n    'completed_orders', COUNT(*) FILTER (WHERE status = 'completed')\n  )\n  INTO result\n  FROM orders\n  WHERE team_id = p_team_id AND pickup_date = p_date;\n\n  RETURN result;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "get_or_create_conversation",
    "definition": "CREATE OR REPLACE FUNCTION public.get_or_create_conversation(p_team_id uuid, p_line_user_id text)\n RETURNS TABLE(id uuid, team_id uuid, line_user_id text, status text, collected_data jsonb, missing_fields text[], order_id uuid, last_message_at timestamp with time zone, created_at timestamp with time zone, updated_at timestamp with time zone)\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  v_conversation_id UUID;\nBEGIN\n  -- 查找進行中的對話（collecting_info 狀態）\n  SELECT c.id INTO v_conversation_id\n  FROM conversations c\n  WHERE c.team_id = p_team_id \n    AND c.line_user_id = p_line_user_id \n    AND c.status = 'collecting_info'\n  ORDER BY c.last_message_at DESC\n  LIMIT 1;\n\n  -- 如果找到，更新最後訊息時間\n  IF v_conversation_id IS NOT NULL THEN\n    UPDATE conversations\n    SET last_message_at = NOW(),\n        updated_at = NOW()\n    WHERE conversations.id = v_conversation_id;\n  ELSE\n    -- 如果沒有找到，建立新對話\n    INSERT INTO conversations (team_id, line_user_id, status)\n    VALUES (p_team_id, p_line_user_id, 'collecting_info')\n    RETURNING conversations.id INTO v_conversation_id;\n  END IF;\n\n  -- 回傳對話記錄\n  RETURN QUERY\n  SELECT \n    c.id, c.team_id, c.line_user_id, c.status, \n    c.collected_data, c.missing_fields, c.order_id,\n    c.last_message_at, c.created_at, c.updated_at\n  FROM conversations c\n  WHERE c.id = v_conversation_id;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "get_or_create_invite_code",
    "definition": "CREATE OR REPLACE FUNCTION public.get_or_create_invite_code(p_team_id uuid, p_user_id uuid)\n RETURNS text\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  v_invite_code TEXT;\n  v_team_slug TEXT;\nBEGIN\n  -- 檢查用戶是否有權限\n  IF NOT EXISTS (\n    SELECT 1 FROM team_members\n    WHERE team_id = p_team_id \n      AND user_id = p_user_id\n      AND (role IN ('owner', 'admin') OR can_invite_members = true)\n  ) THEN\n    RAISE EXCEPTION 'User does not have permission to generate invite codes';\n  END IF;\n\n  -- 查找現有的活躍邀請碼\n  SELECT invite_code INTO v_invite_code\n  FROM team_invites\n  WHERE team_id = p_team_id\n    AND is_active = true\n    AND (expires_at IS NULL OR expires_at > NOW())\n    AND (max_uses IS NULL OR uses_count < max_uses)\n  ORDER BY created_at DESC\n  LIMIT 1;\n\n  -- 如果沒有，建立新的\n  IF v_invite_code IS NULL THEN\n    SELECT slug INTO v_team_slug FROM teams WHERE id = p_team_id;\n    v_invite_code := generate_invite_code(v_team_slug);\n    \n    INSERT INTO team_invites (\n      team_id,\n      invite_code,\n      invited_by,\n      role,\n      is_active\n    )\n    VALUES (\n      p_team_id,\n      v_invite_code,\n      p_user_id,\n      'member',\n      true\n    );\n  END IF;\n\n  RETURN v_invite_code;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "get_order_conversation",
    "definition": "CREATE OR REPLACE FUNCTION public.get_order_conversation(p_order_id uuid)\n RETURNS TABLE(role text, message text, message_timestamp timestamp with time zone)\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  v_conversation_id UUID;\nBEGIN\n  -- 取得訂單關聯的對話 ID\n  SELECT conversation_id INTO v_conversation_id\n  FROM orders\n  WHERE id = p_order_id;\n\n  -- 如果沒有對話記錄，回傳空結果\n  IF v_conversation_id IS NULL THEN\n    RETURN;\n  END IF;\n\n  -- 回傳完整對話記錄（依時間順序）\n  RETURN QUERY\n  SELECT \n    lm.role,\n    lm.message_text AS message,\n    lm.created_at AS message_timestamp\n  FROM line_messages lm\n  WHERE lm.conversation_id = v_conversation_id\n  ORDER BY lm.created_at ASC; -- 順序排列（舊到新）\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "get_team_members",
    "definition": "CREATE OR REPLACE FUNCTION public.get_team_members(p_team_id uuid)\n RETURNS TABLE(member_id uuid, user_id uuid, user_name text, user_picture_url text, role text, joined_at timestamp with time zone, can_manage_orders boolean, can_manage_customers boolean, can_manage_settings boolean, can_view_analytics boolean, can_invite_members boolean)\n LANGUAGE plpgsql\nAS $function$\nBEGIN\n  RETURN QUERY\n  SELECT\n    tm.id AS member_id,\n    tm.user_id,\n    u.line_display_name AS user_name,\n    u.line_picture_url AS user_picture_url,\n    tm.role,\n    tm.joined_at,\n    tm.can_manage_orders,\n    tm.can_manage_customers,\n    tm.can_manage_settings,\n    tm.can_view_analytics,\n    tm.can_invite_members\n  FROM team_members tm\n  JOIN users u ON u.id = tm.user_id\n  WHERE tm.team_id = p_team_id\n  ORDER BY tm.joined_at ASC;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "get_user_teams",
    "definition": "CREATE OR REPLACE FUNCTION public.get_user_teams(p_user_id uuid)\n RETURNS TABLE(team_id uuid, team_name text, team_slug text, role text, member_count integer, order_count integer, subscription_status text, line_channel_name text, line_channel_id text, auto_mode boolean)\n LANGUAGE plpgsql\n STABLE SECURITY DEFINER\nAS $function$\nBEGIN\n  RETURN QUERY\n  SELECT\n    t.id AS team_id,\n    t.name AS team_name,\n    t.slug AS team_slug,\n    tm.role,\n    COALESCE(t.member_count, 0) AS member_count,\n    COALESCE(t.total_orders, 0) AS order_count,\n    t.subscription_status,\n    t.line_channel_name,\n    t.line_channel_id,\n    COALESCE(t.auto_mode, false) AS auto_mode\n  FROM team_members tm\n  INNER JOIN teams t ON t.id = tm.team_id\n  WHERE tm.user_id = p_user_id\n    AND t.deleted_at IS NULL\n  ORDER BY tm.joined_at DESC, t.id;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "handle_auth_user_sync",
    "definition": "CREATE OR REPLACE FUNCTION public.handle_auth_user_sync()\n RETURNS trigger\n LANGUAGE plpgsql\n SECURITY DEFINER\n SET search_path TO 'public'\nAS $function$\r\nDECLARE\r\n  v_line_user_id TEXT;\r\n  v_google_user_id TEXT;\r\n  v_apple_user_id TEXT;\r\n  v_provider TEXT;\r\n  v_display_name TEXT;\r\n  v_picture_url TEXT;\r\nBEGIN\r\n  -- 從 user_metadata 提取資訊\r\n  v_line_user_id := NEW.raw_user_meta_data->>'line_user_id';\r\n  v_google_user_id := NEW.raw_user_meta_data->>'google_user_id';\r\n  v_apple_user_id := NEW.raw_user_meta_data->>'apple_user_id';\r\n  v_provider := COALESCE(\r\n    NEW.raw_user_meta_data->>'auth_provider',\r\n    NEW.raw_app_meta_data->>'provider',\r\n    'unknown'\r\n  );\r\n  v_display_name := COALESCE(\r\n    NEW.raw_user_meta_data->>'display_name',\r\n    NEW.raw_user_meta_data->>'name',\r\n    NEW.email\r\n  );\r\n  v_picture_url := COALESCE(\r\n    NEW.raw_user_meta_data->>'picture_url',\r\n    NEW.raw_user_meta_data->>'avatar_url'\r\n  );\r\n\r\n  -- 如果是 Google/Apple OAuth，從 sub 取得 ID\r\n  IF v_provider = 'google' AND v_google_user_id IS NULL THEN\r\n    v_google_user_id := NEW.raw_user_meta_data->>'sub';\r\n  END IF;\r\n  \r\n  IF v_provider = 'apple' AND v_apple_user_id IS NULL THEN\r\n    v_apple_user_id := NEW.raw_user_meta_data->>'sub';\r\n  END IF;\r\n\r\n  -- Upsert 到 public.users\r\n  -- 優先使用各 provider 的 ID 作為衝突檢查\r\n  INSERT INTO public.users (\r\n    auth_user_id,\r\n    line_user_id,\r\n    google_user_id,\r\n    apple_user_id,\r\n    line_display_name,\r\n    line_email,\r\n    line_picture_url,\r\n    auth_provider,\r\n    last_login_at,\r\n    created_at,\r\n    updated_at\r\n  )\r\n  VALUES (\r\n    NEW.id,\r\n    v_line_user_id,\r\n    v_google_user_id,\r\n    v_apple_user_id,\r\n    v_display_name,\r\n    NEW.email,\r\n    v_picture_url,\r\n    v_provider,\r\n    NOW(),\r\n    NOW(),\r\n    NOW()\r\n  )\r\n  ON CONFLICT (auth_user_id) \r\n  DO UPDATE SET\r\n    line_user_id = COALESCE(EXCLUDED.line_user_id, users.line_user_id),\r\n    google_user_id = COALESCE(EXCLUDED.google_user_id, users.google_user_id),\r\n    apple_user_id = COALESCE(EXCLUDED.apple_user_id, users.apple_user_id),\r\n    line_display_name = COALESCE(EXCLUDED.line_display_name, users.line_display_name),\r\n    line_email = COALESCE(EXCLUDED.line_email, users.line_email),\r\n    line_picture_url = COALESCE(EXCLUDED.line_picture_url, users.line_picture_url),\r\n    auth_provider = EXCLUDED.auth_provider,\r\n    last_login_at = NOW(),\r\n    updated_at = NOW();\r\n\r\n  RAISE NOTICE '[Auth Sync] Synced user: % (provider: %)', NEW.id, v_provider;\r\n  \r\n  RETURN NEW;\r\nEND;\r\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "initialize_trial",
    "definition": "CREATE OR REPLACE FUNCTION public.initialize_trial(p_team_id uuid)\n RETURNS void\n LANGUAGE plpgsql\nAS $function$\nBEGIN\n  UPDATE teams\n  SET\n    subscription_status = 'trial',\n    trial_started_at = NOW(),\n    trial_ends_at = NOW() + INTERVAL '3 days'\n  WHERE id = p_team_id;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "leave_team",
    "definition": "CREATE OR REPLACE FUNCTION public.leave_team(p_team_id uuid, p_user_id uuid)\n RETURNS boolean\n LANGUAGE plpgsql\nAS $function$\nDECLARE\n  v_member_role TEXT;\n  v_owner_count INT;\nBEGIN\n  -- 檢查成員是否存在\n  SELECT role INTO v_member_role\n  FROM team_members\n  WHERE team_id = p_team_id AND user_id = p_user_id;\n\n  IF v_member_role IS NULL THEN\n    RAISE EXCEPTION 'User is not a member of this team';\n  END IF;\n\n  -- 如果是 owner，檢查是否還有其他 owner\n  IF v_member_role = 'owner' THEN\n    SELECT COUNT(*) INTO v_owner_count\n    FROM team_members\n    WHERE team_id = p_team_id AND role = 'owner';\n\n    IF v_owner_count <= 1 THEN\n      RAISE EXCEPTION 'Cannot leave team: You are the only owner. Transfer ownership or delete the team.';\n    END IF;\n  END IF;\n\n  -- 移除成員\n  DELETE FROM team_members\n  WHERE team_id = p_team_id AND user_id = p_user_id;\n\n  -- 更新團隊成員數\n  UPDATE teams\n  SET member_count = member_count - 1\n  WHERE id = p_team_id;\n\n  RETURN true;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "update_conversation_data",
    "definition": "CREATE OR REPLACE FUNCTION public.update_conversation_data(p_conversation_id uuid, p_collected_data jsonb, p_missing_fields text[])\n RETURNS void\n LANGUAGE plpgsql\nAS $function$\nBEGIN\n  UPDATE conversations\n  SET \n    collected_data = p_collected_data,\n    missing_fields = p_missing_fields,\n    updated_at = NOW(),\n    last_message_at = NOW()\n  WHERE id = p_conversation_id;\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "update_expired_subscriptions",
    "definition": "CREATE OR REPLACE FUNCTION public.update_expired_subscriptions()\n RETURNS void\n LANGUAGE plpgsql\nAS $function$\nBEGIN\n  -- 試用期過期\n  UPDATE teams\n  SET subscription_status = 'expired'\n  WHERE subscription_status = 'trial'\n    AND trial_ends_at < NOW();\n\n  -- 付費訂閱過期\n  UPDATE teams\n  SET subscription_status = 'expired'\n  WHERE subscription_status = 'active'\n    AND subscription_current_period_end < NOW();\nEND;\n$function$\n"
  },
  {
    "schema": "public",
    "function_name": "update_updated_at_column",
    "definition": "CREATE OR REPLACE FUNCTION public.update_updated_at_column()\n RETURNS trigger\n LANGUAGE plpgsql\nAS $function$\nBEGIN\n  NEW.updated_at = NOW();\n  RETURN NEW;\nEND;\n$function$\n"
  }
]
