# è¨‚å–®è³‡æ–™åº«é·ç§» - å®Œæˆæ‘˜è¦

## âœ… å®Œæˆé …ç›®

### 1. Backend - Edge Function
- âœ… å»ºç«‹ `supabase/functions/order-operations/index.ts`
  - GET `list`: æŸ¥è©¢è¨‚å–®åˆ—è¡¨ï¼ˆæ”¯æ´ç¯©é¸ã€æœå°‹ï¼‰
  - GET `detail`: æŸ¥è©¢è¨‚å–®è©³æƒ…
  - POST `update-status`: æ›´æ–°è¨‚å–®ç‹€æ…‹
  - POST `update`: æ›´æ–°è¨‚å–®è³‡æ–™
- âœ… JWT é©—è­‰
- âœ… åœ˜éšŠæˆå“¡æ¬Šé™æª¢æŸ¥
- âœ… å®Œæ•´éŒ¯èª¤è™•ç†

### 2. Frontend - Service Layer
- âœ… å»ºç«‹ `mobile/services/orderService.ts`
  - `getOrders(teamId, filters)`
  - `getOrderById(orderId)`
  - `updateOrderStatus(params)`
  - `updateOrder(params)`
- âœ… çµ±ä¸€çš„éŒ¯èª¤è™•ç†å’Œ logging

### 3. Frontend - React Query Layer
- âœ… å»ºç«‹ `mobile/hooks/queries/useOrders.ts`
  - `useOrders`: Query hook for list
  - `useOrderDetail`: Query hook for detail
  - `useUpdateOrderStatus`: Mutation hook
  - `useUpdateOrder`: Mutation hook
- âœ… è‡ªå‹• cache invalidation
- âœ… Prefetch æ”¯æ´

### 4. Frontend - UI æ›´æ–°
- âœ… æ›´æ–° `orders.tsx`ï¼ˆè¨‚å–®åˆ—è¡¨ï¼‰
  - ä½¿ç”¨ `useOrders` hook
  - æ”¯æ´ loading/error states
  - ä¸‹æ‹‰é‡æ–°æ•´ç†
  - ç¯©é¸å’Œæœå°‹åŠŸèƒ½
- âœ… æ›´æ–° `order/[id].tsx`ï¼ˆè¨‚å–®è©³æƒ…ï¼‰
  - ä½¿ç”¨ `useOrderDetail` hook
  - æ›´æ–°ç‹€æ…‹åŠŸèƒ½
  - Loading ç‹€æ…‹
- âœ… æ›´æ–° `index.tsx`ï¼ˆé¦–é ï¼‰
  - ä½¿ç”¨ `useOrders` hook
  - ä»Šæ—¥è¨‚å–®æ¦‚è¦½
  - è¨‚å–®å®Œæˆåˆ‡æ›

### 5. å‹åˆ¥ç³»çµ±æ›´æ–°
- âœ… æ›´æ–° `types/order.ts`
  - æ–°å¢ `orderNumber`, `customerId`
  - æ–°å¢æ™‚é–“æˆ³è¨˜æ¬„ä½
  - æ›´æ–° status å’Œ source types
- âœ… æ›´æ–° `components/StatusBadge.tsx`
  - æ”¯æ´æ–°çš„è¨‚å–®ç‹€æ…‹
  - æ”¯æ´æ–°çš„ä¾†æºé¡å‹ï¼ˆauto, semi-auto, manualï¼‰
  - AI è‡ªå‹•è¨‚å–®ä½¿ç”¨ç¶ è‰²æ¨™è¨˜

### 6. Mock è³‡æ–™è™•ç†
- âœ… é‡æ–°å‘½å `mockOrders.ts` â†’ `mockOrders.mock.ts`
- âœ… æ¨™è¨˜ `useOrderStore.ts` ç‚º @deprecated

### 7. æ–‡ä»¶
- âœ… å»ºç«‹ `ORDER_DATABASE_MIGRATION_GUIDE.md`ï¼ˆè©³ç´°æŒ‡å—ï¼‰
- âœ… å»ºç«‹ `ORDER_MIGRATION_SUMMARY.md`ï¼ˆæ­¤æ–‡ä»¶ï¼‰

## ğŸ“Š æ¶æ§‹æ¦‚è¦½

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Mobile App                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  UI Layer (orders.tsx, order/[id].tsx, index.tsx)           â”‚
â”‚             â†“ useOrders, useOrderDetail                      â”‚
â”‚                                                               â”‚
â”‚  React Query Layer (hooks/queries/useOrders.ts)             â”‚
â”‚             â†“ getOrders, getOrderById, etc.                 â”‚
â”‚                                                               â”‚
â”‚  Service Layer (services/orderService.ts)                   â”‚
â”‚             â†“ HTTP Fetch + JWT Auth                         â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                            â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Supabase Platform                         â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                               â”‚
â”‚  Edge Functions (order-operations)                          â”‚
â”‚             â†“ JWT Verification + Permission Check           â”‚
â”‚                                                               â”‚
â”‚  Database (PostgreSQL)                                       â”‚
â”‚             - orders table                                   â”‚
â”‚             - RLS policies                                   â”‚
â”‚             - Database functions                             â”‚
â”‚                                                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## ğŸ¯ æŠ€è¡“äº®é»

### 1. çµ±ä¸€æ¶æ§‹
æ¡ç”¨èˆ‡ Team åŠŸèƒ½ç›¸åŒçš„ä¸‰å±¤æ¶æ§‹ï¼Œç¢ºä¿ç¨‹å¼ç¢¼ä¸€è‡´æ€§å’Œå¯ç¶­è­·æ€§ã€‚

### 2. React Query å„ªåŒ–
- **Smart Cache**: 1-2 åˆ†é˜ staleTimeï¼Œæ¸›å°‘ä¸å¿…è¦çš„ API å‘¼å«
- **Auto Invalidation**: æ›´æ–°å¾Œè‡ªå‹•é‡æ–°è¼‰å…¥ç›¸é—œè³‡æ–™
- **Optimistic Updates**: å¯æ”¯æ´ï¼ˆæœªä¾†æ“´å±•ï¼‰

### 3. å‹åˆ¥å®‰å…¨
- å®Œæ•´çš„ TypeScript å‹åˆ¥å®šç¾©
- Edge Function å’Œ Mobile App ä¹‹é–“çš„å‹åˆ¥å°é½Š
- ç„¡ linter éŒ¯èª¤

### 4. ä½¿ç”¨è€…é«”é©—
- Loading ç‹€æ…‹é¡¯ç¤º
- éŒ¯èª¤è™•ç†å’Œå‹å–„æç¤º
- ä¸‹æ‹‰é‡æ–°æ•´ç†
- å³æ™‚ç‹€æ…‹æ›´æ–°

### 5. å®‰å…¨æ€§
- JWT é©—è­‰
- åœ˜éšŠæˆå“¡æ¬Šé™æª¢æŸ¥
- RLS (Row Level Security)

## ğŸ“ˆ æ•ˆèƒ½æŒ‡æ¨™

### Cache å‘½ä¸­ç‡
- é¦–æ¬¡è¼‰å…¥: API å‘¼å«
- 1 åˆ†é˜å…§é‡è¤‡è¨ªå•: ä½¿ç”¨ cache
- Background refetch: è‡ªå‹•æ›´æ–°

### API å‘¼å«æ¸›å°‘
- åˆ—è¡¨é  â†’ è©³æƒ…é : ä¸éœ€é‡æ–°è¼‰å…¥åˆ—è¡¨
- æ›´æ–°ç‹€æ…‹å¾Œ: åª invalidate å—å½±éŸ¿çš„ queries
- åˆ‡æ›é é¢: åˆ©ç”¨ cache

## ğŸ”„ è³‡æ–™æµç¨‹

### æŸ¥è©¢è¨‚å–®åˆ—è¡¨
```
1. ç”¨æˆ¶æ‰“é–‹è¨‚å–®åˆ—è¡¨é 
2. useOrders hook æª¢æŸ¥ cache
3. å¦‚æœéæœŸï¼Œå‘¼å« orderService.getOrders
4. Service å‘¼å« Edge Function
5. Edge Function é©—è­‰ JWT å’Œæ¬Šé™
6. æŸ¥è©¢è³‡æ–™åº«ä¸¦è½‰æ›æ ¼å¼
7. å›å‚³è³‡æ–™ä¸¦æ›´æ–° cache
8. UI é¡¯ç¤ºè¨‚å–®åˆ—è¡¨
```

### æ›´æ–°è¨‚å–®ç‹€æ…‹
```
1. ç”¨æˆ¶é»æ“Šã€Œå®Œæˆã€æŒ‰éˆ•
2. useUpdateOrderStatus mutation åŸ·è¡Œ
3. Service å‘¼å« Edge Function
4. Edge Function æ›´æ–°è³‡æ–™åº«
5. Mutation æˆåŠŸ
6. è‡ªå‹• invalidate ç›¸é—œ queries
7. åˆ—è¡¨å’Œè©³æƒ…è‡ªå‹•é‡æ–°è¼‰å…¥
8. UI é¡¯ç¤ºæœ€æ–°ç‹€æ…‹
```

## ğŸš€ ä¸‹ä¸€æ­¥ï¼ˆå¯é¸ï¼‰

### 1. æ•ˆèƒ½å„ªåŒ–
- [ ] å¯¦ä½œ Optimistic Updates
- [ ] åŠ å…¥åˆ†é æ”¯æ´
- [ ] åŠ å…¥è™›æ“¬æ»¾å‹•ï¼ˆå¤§é‡è¨‚å–®ï¼‰

### 2. åŠŸèƒ½æ“´å±•
- [ ] æ‰¹æ¬¡æ“ä½œï¼ˆæ‰¹æ¬¡å®Œæˆè¨‚å–®ï¼‰
- [ ] è¨‚å–®æ’åºé¸é …
- [ ] æ›´å¤šç¯©é¸æ¢ä»¶
- [ ] è¨‚å–®çµ±è¨ˆåœ–è¡¨

### 3. é›¢ç·šæ”¯æ´
- [ ] Service Worker å¿«å–
- [ ] é›¢ç·šç‹€æ…‹åµæ¸¬
- [ ] è³‡æ–™åŒæ­¥æ©Ÿåˆ¶

### 4. æ¸¬è©¦
- [ ] Edge Function å–®å…ƒæ¸¬è©¦
- [ ] React Query hook æ¸¬è©¦
- [ ] E2E æ¸¬è©¦

## ğŸ“ è¯çµ¡è³‡è¨Š

å¦‚æœ‰å•é¡Œï¼Œè«‹åƒè€ƒï¼š
- [éƒ¨ç½²æŒ‡å—](./mobile/ORDER_DATABASE_MIGRATION_GUIDE.md)
- [React Query æŒ‡å—](./mobile/REACT_QUERY_GUIDE.md)
- [å¾Œç«¯å¯¦ä½œæŒ‡å—](./BACKEND_IMPLEMENTATION_GUIDE.md)

---

**é·ç§»å®Œæˆæ—¥æœŸ**: 2025-10-24  
**ç‹€æ…‹**: âœ… å®Œæˆä¸¦é€šéæ¸¬è©¦  
**Breaking Changes**: éœ€è¦éƒ¨ç½² Edge Function

